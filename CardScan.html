<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>CardScan</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 24px;
            font-size: 32px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .setup-section {
            display: none;
        }
        
        .setup-section.active {
            display: block;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        input[type="text"],
        input[type="password"],
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus,
        input[type="password"]:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }
        
        button {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 12px;
        }
        
        button:active {
            transform: scale(0.98);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .secondary-btn {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }
        
        .photo-preview {
            width: 100%;
            max-height: 300px;
            object-fit: contain;
            border-radius: 8px;
            margin: 12px 0;
            border: 2px solid #e0e0e0;
        }
        
        .status {
            text-align: center;
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
            font-weight: 500;
        }
        
        .status.info {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .status.success {
            background: #e8f5e9;
            color: #388e3c;
        }
        
        .status.error {
            background: #ffebee;
            color: #c62828;
        }
        
        .status.processing {
            background: #fff3e0;
            color: #f57c00;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .file-input-label {
            display: block;
            width: 100%;
            padding: 16px;
            background: white;
            color: #667eea;
            border: 2px dashed #667eea;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            transition: background 0.3s;
        }
        
        .file-input-label:active {
            background: #f5f5f5;
        }
        
        .contact-preview {
            background: #f5f5f5;
            padding: 16px;
            border-radius: 8px;
            margin: 12px 0;
        }
        
        .contact-preview div {
            margin: 8px 0;
        }
        
        .contact-preview strong {
            color: #667eea;
        }
        
        .hidden {
            display: none;
        }
        
        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ“‡ CardScan</h1>
        
        <!-- API Key Setup -->
        <div id="setup" class="card setup-section active">
            <h2 style="margin-bottom: 16px;">Setup API Key</h2>
            <label for="apiKey">Anthropic API Key:</label>
            <input type="password" id="apiKey" placeholder="sk-ant-...">
            <button onclick="saveApiKey()">Save & Start</button>
            <div id="setupStatus"></div>
        </div>
        
        <!-- Main App -->
        <div id="app" class="card setup-section">
            <div id="step1" class="step">
                <h2 style="margin-bottom: 16px;">Step 1: Photo Front</h2>
                <label for="photo1" class="file-input-label">
                    ðŸ“¸ Take Photo of Front
                </label>
                <input type="file" id="photo1" accept="image/*" capture="environment" onchange="handlePhoto1()">
                <img id="preview1" class="photo-preview hidden">
                <button id="nextBtn1" class="hidden" onclick="askForSecondSide()">Next â†’</button>
            </div>
            
            <div id="step2" class="step hidden">
                <h2 style="margin-bottom: 16px;">Step 2: Second Side?</h2>
                <div class="status info">Does this card have information on the back?</div>
                <div class="btn-group">
                    <button onclick="skipSecondSide()">No</button>
                    <button onclick="takeSecondSide()">Yes, Take Photo</button>
                </div>
            </div>
            
            <div id="step2b" class="step hidden">
                <h2 style="margin-bottom: 16px;">Photo Back Side</h2>
                <label for="photo2" class="file-input-label">
                    ðŸ“¸ Take Photo of Back
                </label>
                <input type="file" id="photo2" accept="image/*" capture="environment" onchange="handlePhoto2()">
                <img id="preview2" class="photo-preview hidden">
                <button id="nextBtn2" class="hidden" onclick="askForNotes()">Next â†’</button>
            </div>
            
            <div id="step3" class="step hidden">
                <h2 style="margin-bottom: 16px;">Step 3: Add Notes?</h2>
                <label for="notes">Notes about this person (optional):</label>
                <textarea id="notes" placeholder="Met at conference, potential client, etc."></textarea>
                <button onclick="processCard()">Process Card â†’</button>
            </div>
            
            <div id="step4" class="step hidden">
                <h2 style="margin-bottom: 16px;">Processing...</h2>
                <div id="processingStatus" class="status processing">
                    Extracting contact information with AI...
                </div>
            </div>
            
            <div id="step5" class="step hidden">
                <h2 style="margin-bottom: 16px;">Review Contact</h2>
                <div id="contactPreview" class="contact-preview"></div>
                <button onclick="downloadVCard()">Download vCard</button>
                <button class="secondary-btn" onclick="startOver()">Scan Another Card</button>
            </div>
            
            <div id="errorSection" class="hidden">
                <div class="status error" id="errorMessage"></div>
                <button class="secondary-btn" onclick="startOver()">Try Again</button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let apiKey = '';
        let photo1Base64 = '';
        let photo2Base64 = '';
        let contactData = null;
        
        // Check for saved API key on load
        window.onload = function() {
            const saved = localStorage.getItem('anthropicApiKey');
            if (saved) {
                apiKey = saved;
                document.getElementById('setup').classList.remove('active');
                document.getElementById('app').classList.add('active');
            }
        };
        
        function saveApiKey() {
            const key = document.getElementById('apiKey').value.trim();
            if (!key.startsWith('sk-ant-')) {
                showStatus('setupStatus', 'Invalid API key format', 'error');
                return;
            }
            
            apiKey = key;
            localStorage.setItem('anthropicApiKey', key);
            document.getElementById('setup').classList.remove('active');
            document.getElementById('app').classList.add('active');
        }
        
        function handlePhoto1() {
            const file = document.getElementById('photo1').files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                photo1Base64 = e.target.result.split(',')[1];
                document.getElementById('preview1').src = e.target.result;
                document.getElementById('preview1').classList.remove('hidden');
                document.getElementById('nextBtn1').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }
        
        function askForSecondSide() {
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');
        }
        
        function skipSecondSide() {
            photo2Base64 = '';
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step3').classList.remove('hidden');
        }
        
        function takeSecondSide() {
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step2b').classList.remove('hidden');
        }
        
        function handlePhoto2() {
            const file = document.getElementById('photo2').files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                photo2Base64 = e.target.result.split(',')[1];
                document.getElementById('preview2').src = e.target.result;
                document.getElementById('preview2').classList.remove('hidden');
                document.getElementById('nextBtn2').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }
        
        function askForNotes() {
            document.getElementById('step2b').classList.add('hidden');
            document.getElementById('step3').classList.remove('hidden');
        }
        
        async function processCard() {
            document.getElementById('step3').classList.add('hidden');
            document.getElementById('step4').classList.remove('hidden');
            
            try {
                const notes = document.getElementById('notes').value.trim();
                const today = new Date().toISOString().split('T')[0];
                
                // Prepare content for API
                const content = [
                    {
                        type: "image",
                        source: {
                            type: "base64",
                            media_type: "image/jpeg",
                            data: photo1Base64
                        }
                    }
                ];
                
                if (photo2Base64) {
                    content.push({
                        type: "image",
                        source: {
                            type: "base64",
                            media_type: "image/jpeg",
                            data: photo2Base64
                        }
                    });
                }
                
                content.push({
                    type: "text",
                    text: `Extract all contact information from this business card image${photo2Base64 ? 's (front and back)' : ''} and return ONLY a JSON object with the following fields:
{
  "firstName": "",
  "lastName": "",
  "fullName": "",
  "company": "",
  "title": "",
  "email": "",
  "phone": "",
  "mobile": "",
  "address": "",
  "website": "",
  "notes": "${notes}"
}

Fill in all available fields. Use empty strings for missing information. For phone numbers, preserve the format shown on the card. The notes field should contain: "${notes}".`
                });
                
                // Call Claude API
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-3-5-sonnet-20241022',
                        max_tokens: 1024,
                        messages: [{
                            role: 'user',
                            content: content
                        }]
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                const text = data.content[0].text;
                
                // Extract JSON from response
                const jsonMatch = text.match(/\{[\s\S]*\}/);
                if (!jsonMatch) {
                    throw new Error('Could not extract contact data from response');
                }
                
                contactData = JSON.parse(jsonMatch[0]);
                contactData.dateAdded = today;
                
                displayContactPreview();
                
            } catch (error) {
                showError('Error processing card: ' + error.message);
            }
        }
        
        function displayContactPreview() {
            document.getElementById('step4').classList.add('hidden');
            document.getElementById('step5').classList.remove('hidden');
            
            const preview = document.getElementById('contactPreview');
            let html = '';
            
            if (contactData.fullName) html += `<div><strong>Name:</strong> ${contactData.fullName}</div>`;
            if (contactData.title) html += `<div><strong>Title:</strong> ${contactData.title}</div>`;
            if (contactData.company) html += `<div><strong>Company:</strong> ${contactData.company}</div>`;
            if (contactData.email) html += `<div><strong>Email:</strong> ${contactData.email}</div>`;
            if (contactData.phone) html += `<div><strong>Phone:</strong> ${contactData.phone}</div>`;
            if (contactData.mobile) html += `<div><strong>Mobile:</strong> ${contactData.mobile}</div>`;
            if (contactData.address) html += `<div><strong>Address:</strong> ${contactData.address}</div>`;
            if (contactData.website) html += `<div><strong>Website:</strong> ${contactData.website}</div>`;
            if (contactData.notes) html += `<div><strong>Notes:</strong> ${contactData.notes}</div>`;
            if (contactData.dateAdded) html += `<div><strong>Date Added:</strong> ${contactData.dateAdded}</div>`;
            
            preview.innerHTML = html;
        }
        
        function downloadVCard() {
            const vcard = generateVCard(contactData);
            const blob = new Blob([vcard], { type: 'text/vcard' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${contactData.fullName || 'contact'}.vcf`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function generateVCard(data) {
            let vcard = 'BEGIN:VCARD\nVERSION:3.0\n';
            
            if (data.fullName) {
                vcard += `FN:${data.fullName}\n`;
                const nameParts = data.fullName.split(' ');
                const lastName = nameParts.length > 1 ? nameParts[nameParts.length - 1] : '';
                const firstName = nameParts.length > 1 ? nameParts.slice(0, -1).join(' ') : data.fullName;
                vcard += `N:${lastName};${firstName};;;\n`;
            }
            
            if (data.company) vcard += `ORG:${data.company}\n`;
            if (data.title) vcard += `TITLE:${data.title}\n`;
            if (data.email) vcard += `EMAIL;TYPE=INTERNET:${data.email}\n`;
            if (data.phone) vcard += `TEL;TYPE=WORK,VOICE:${data.phone}\n`;
            if (data.mobile) vcard += `TEL;TYPE=CELL:${data.mobile}\n`;
            if (data.website) vcard += `URL:${data.website}\n`;
            if (data.address) vcard += `ADR;TYPE=WORK:;;${data.address};;;;\n`;
            
            // Combine notes and date added
            let noteText = '';
            if (data.notes) noteText += data.notes;
            if (data.dateAdded) {
                if (noteText) noteText += ' | ';
                noteText += `Added: ${data.dateAdded}`;
            }
            if (noteText) vcard += `NOTE:${noteText}\n`;
            
            vcard += 'END:VCARD';
            return vcard;
        }
        
        function showError(message) {
            document.getElementById('step4').classList.add('hidden');
            document.getElementById('errorSection').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
        }
        
        function showStatus(elementId, message, type) {
            const el = document.getElementById(elementId);
            el.className = `status ${type}`;
            el.textContent = message;
        }
        
        function startOver() {
            // Reset state
            photo1Base64 = '';
            photo2Base64 = '';
            contactData = null;
            
            // Reset form
            document.getElementById('photo1').value = '';
            document.getElementById('photo2').value = '';
            document.getElementById('notes').value = '';
            document.getElementById('preview1').classList.add('hidden');
            document.getElementById('preview2').classList.add('hidden');
            document.getElementById('nextBtn1').classList.add('hidden');
            document.getElementById('nextBtn2').classList.add('hidden');
            
            // Show step 1
            document.querySelectorAll('.step').forEach(step => step.classList.add('hidden'));
            document.getElementById('step1').classList.remove('hidden');
            document.getElementById('errorSection').classList.add('hidden');
        }
    </script>
</body>
</html>
